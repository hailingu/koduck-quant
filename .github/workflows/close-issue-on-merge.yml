name: Close Issue on PR Merge to Dev

on:
  pull_request:
    types: [closed]
    branches:
      - dev

jobs:
  close-issue:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Close linked issues
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            
            // 匹配关闭关键词：close, closes, closed, fix, fixes, fixed, resolve, resolves, resolved
            // 支持格式：Closes #123, fixes #456, close #789 等
            const closePattern = /(?:close|fix|resolve)(?:s|d)?\s*#(\d+)/gi;
            const matches = [...prBody.matchAll(closePattern)];
            
            // 也去 PR 标题中查找
            const titleMatches = [...prTitle.matchAll(closePattern)];
            
            // 合并所有匹配的 issue 编号（去重）
            const issueNumbers = [...new Set([
              ...matches.map(m => parseInt(m[1])),
              ...titleMatches.map(m => parseInt(m[1]))
            ])];
            
            if (issueNumbers.length === 0) {
              console.log('No linked issues found in PR body or title');
              return;
            }
            
            console.log(`Found ${issueNumbers.length} linked issue(s): #${issueNumbers.join(', #')}`);
            
            for (const issueNumber of issueNumbers) {
              try {
                // 获取 issue 信息
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                
                // 如果 issue 已经是关闭状态，跳过
                if (issue.state === 'closed') {
                  console.log(`Issue #${issueNumber} is already closed, skipping`);
                  continue;
                }
                
                // 关闭 issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed',
                  state_reason: 'completed'
                });
                
                // 添加评论说明是哪个 PR 关闭的
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `✅ Completed via PR #${prNumber} and merged into \`dev\` branch.`
                });
                
                console.log(`✅ Closed issue #${issueNumber}`);
              } catch (error) {
                if (error.status === 404) {
                  console.log(`⚠️ Issue #${issueNumber} not found or not accessible`);
                } else if (error.status === 410) {
                  console.log(`⚠️ Issue #${issueNumber} was deleted`);
                } else {
                  console.error(`❌ Failed to close issue #${issueNumber}: ${error.message}`);
                }
              }
            }
